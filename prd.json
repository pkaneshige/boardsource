{
  "project": "BoardSource Surfboard Catalog",
  "branchName": "ralph/price-alerts",
  "description": "In-app price drop and back-in-stock alerts for surfboards. Users set alerts from the product detail page; alerts trigger during sync and appear via a notification bell in the header.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create priceAlert and notification Sanity schemas",
      "description": "As a developer, I need document types to store alert subscriptions and triggered notifications.",
      "acceptanceCriteria": [
        "Create lib/cms/schemas/price-alert.ts with priceAlert document type: email (string, required), surfboard (reference to surfboard, required), alertType (string: 'price_drop' | 'back_in_stock'), targetPrice (number, optional), active (boolean, default true), createdAt (datetime, required)",
        "Create lib/cms/schemas/notification.ts with notification document type: email (string, required), surfboard (reference to surfboard, required), alertType (string), message (string), previousPrice (number, optional), newPrice (number, optional), read (boolean, default false), createdAt (datetime, required)",
        "Add both schemas to lib/cms/schemas/index.ts exports and schemaTypes array",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Create alert management API routes",
      "description": "As a developer, I need API endpoints to create, list, and deactivate price alerts.",
      "acceptanceCriteria": [
        "Create POST app/api/alerts/route.ts — accepts { email, surfboardId, alertType, targetPrice? }, validates required fields, prevents duplicate active alerts for same email+surfboard+type, creates priceAlert document, returns { id } with 201 status",
        "Create GET app/api/alerts/route.ts — accepts ?email= query param, returns array of active alerts with surfboard name and slug",
        "Create DELETE app/api/alerts/[id]/route.ts — sets alert active to false, returns 200",
        "All endpoints return proper error responses (400 for validation, 404 for not found)",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Check and trigger alerts during sync",
      "description": "As a developer, I want the sync to automatically check alerts when prices or stock status change.",
      "acceptanceCriteria": [
        "Create lib/cms/alerts.ts with checkAlerts(surfboardId, newPrice, newStockStatus, oldPrice?, oldStockStatus?) function",
        "For price_drop alerts: trigger when newPrice <= targetPrice and alert is active",
        "For back_in_stock alerts: trigger when oldStockStatus was 'out_of_stock' and newStockStatus is 'in_stock' and alert is active",
        "When triggered: create a notification document with descriptive message and set the alert active to false",
        "Integrate into upsertSurfboard in write-client.ts: fetch existing surfboard price/stockStatus before the upsert, then call checkAlerts after successful upsert with old and new values",
        "Function is resilient: wraps in try/catch so failures don't break sync",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Add price alert form on product detail page",
      "description": "As a user, I want to set a price alert from the surfboard detail page.",
      "acceptanceCriteria": [
        "Create app/surfboards/[slug]/price-alert-form.tsx as 'use client' component",
        "Props: surfboardId (string), currentPrice (number), stockStatus (string)",
        "Shows a 'Set Price Alert' button that expands into a form on click",
        "Form has: email input (required), alert type radio buttons (Price Drop / Back in Stock), target price number input (only shown for Price Drop, pre-filled with currentPrice * 0.9 rounded to nearest dollar)",
        "Back in Stock radio option only visible when stockStatus is 'out_of_stock'",
        "Submits to POST /api/alerts, shows success message or error",
        "Stores email in localStorage so it's pre-filled on next visit",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Create notification API routes and bell component",
      "description": "As a user, I want to see my triggered alerts via a notification bell in the header.",
      "acceptanceCriteria": [
        "Create GET app/api/notifications/route.ts — accepts ?email= query param, returns notifications sorted by createdAt desc with surfboard name and slug",
        "Create PATCH app/api/notifications/[id]/route.ts — sets read to true",
        "Create PATCH app/api/notifications/read-all/route.ts — marks all unread notifications for an email as read",
        "Create components/notification-bell.tsx as 'use client' component",
        "Shows bell icon with red unread count badge (hidden when 0)",
        "Clicking opens dropdown with notification list: board name, message, time ago",
        "Each notification links to the surfboard detail page",
        "Mark all read button in dropdown header",
        "Reads email from localStorage; if no email, bell is hidden",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Integrate alert form and notification bell into pages",
      "description": "As a user, I want the alert form on detail pages and the notification bell in the site header.",
      "acceptanceCriteria": [
        "Add PriceAlertForm to app/surfboards/[slug]/page.tsx below the buy button, passing surfboard._id, surfboard.price, and surfboard.stockStatus as props",
        "Add NotificationBell to the site layout header (find existing layout component and add it)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    }
  ]
}
